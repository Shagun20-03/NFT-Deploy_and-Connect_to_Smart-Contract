<html lang="en">

<head>
    <!--Required meta tags-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!--jQuery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>


    <!--Bootstrap CSS-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

    <!--Custom Stylesheet-->
    <link rel="stylesheet" href="/styles/style.css">

    <!--Favicon-->
    <link rel="shortcut icon" href="/assets/favicon.ico" type="image/x-icon">

    <title>NFT Website</title>
</head>

<body class="d-flex flex-column min-vh-100">
    <header>
        <!--Navigation bar-->
        <div class="navbar navbar-dark bg-dark shadow-sm">
            <div class="container">
                <a href="/" class="navbar-brand d-flex align-items-center">
                    <img src="/assets/favicon-32x32.png" alt="icon" width="35" height="35">
                    <strong>NFT MarketPlace</strong>
                </a>
            </div>
        </div>
    </header>

    <main class="form-product">
        <form action="#" id="get-product">
            <div class="mb-3"><label for="token-id" class="form-label">Enter the Token ID </label>
                <input type="number" class="" name="token-id" id="token-id" placeholder="" required>
            </div>
            <button id="submit-token" class="btn btn-warning">Submit</button>
        </form>
    </main>

    <div id="show_product">
        <table class="table">
            <tbody>
                <tr>
                    <th scope="row">Product id: </th>
                    <td id="product_id_show"></td>
                </tr>
                <tr>
                    <th scope="row">Product Name: </th>
                    <td id="product_name_show"></td>
                </tr>
                <tr>
                    <th scope="row">Product Image: </th>
                    <td id="product_image_show"></td>
                </tr>
                <tr>
                    <th scope="row">Product Price: </th>
                    <td id="product_price_show"></td>
                </tr>
                <tr>
                    <th scope="row">Product Description: </th>
                    <td id="product_desc_show"></td>
                </tr>
                <tr>
                    <th scope="row">Warranty Secret Key: </th>
                    <td id="warranty_secret_show"></td>
                </tr>
                <tr>
                    <th scope="row">Expiry Duration (In seconds): </th>
                    <td id="expiry_duration_show"></td>
                </tr>
                <tr>
                    <th scope="row">Warranty Description: </th>
                    <td id="warranty_desc_show"></td>
                </tr>

            </tbody>
        </table>
        <button id="buy_product" type="submit" class="btn btn-warning">Buy Now!!!</button>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.1.2/dist/axios.min.js"></script>
    <script type="module">
        var CONTRACT_ADDRESS = '0x4ed7c70F96B99c776995fB64377f0d4aB3B0e1C1'; //Timer.sol
        var CONTRACT_DEPLOYED = true;

        var CONTRACT = undefined;
        // 1. connect to my MetaMask account
        //2. Deploy
        //3. connect to contract
        import connect from './Connect.js';
        import deploy from './Deploy.js';
        import getContract from './ConnContract.js';
        import { ethers } from './ethers.main.js';

        async function conn() {
            const account = await connect();
        }

        async function getCont() {
            CONTRACT = undefined;
            CONTRACT = await getContract(CONTRACT_ADDRESS);

            let content = '';
            if (CONTRACT) {
                content = 'Contract received!!!!';
            } else {
                content = 'Contract not available';
            }
            console.log(content);
        }
        const ip_addr = '54.83.105.94';
        let TOKEN = 0;
        let secretKey = 0;
        let product_price = 0;
        //Custom functions
        const getProduct = async () => {
            var token1 = (document.querySelector("#token-id").value)
            if (token1) {
                console.log(token1)
            }
            else {
                console.log(token1)
                return;
            }
            await conn();
            await getCont();
            const ipfs_uri = await CONTRACT.tokenURI(
                Number(token1)
            )
            TOKEN = Number(token1);
            console.log(ipfs_uri)
            const response = await axios({
                method: "get",
                url: `http://${ip_addr}/ipfs/${ipfs_uri}`,
            })

            if (response.status == 200) {
                console.log('Success:', response.data);
                let tds = document.querySelectorAll('td')
                tds[0].innerHTML = response.data.Product.product_id;
                tds[1].innerHTML = response.data.Product.product_name;
                tds[2].innerHTML = `<img src="http://${ip_addr}/ipfs/${response.data.Product.product_image_hash}"></img>`
                tds[3].innerHTML = response.data.Product.product_price;
                tds[4].innerHTML = response.data.Product.product_desc;
                tds[5].innerHTML = response.data.warranty.warranty_secretkey;
                tds[6].innerHTML = response.data.warranty.expiry_duration;
                tds[7].innerHTML = response.data.warranty.warranty_desc;
                secretKey = Number(response.data.warranty.warranty_secretkey);
                product_price = Number(response.data.Product.product_price);
            }
        }

        const buyProduct = async () => {
            await conn();
            await getCont();
            if (TOKEN == 0) {
                alert("Please get product!!!");
                return;
            }
            // console.log(TOKEN, secretKey, product_price)
            const txnReceipt = await CONTRACT.buyProduct(
                TOKEN,
                secretKey,
                {
                    value: ethers.utils.parseUnits(product_price.toString(), 'ether')
                }
            )

            const receipt = await txnReceipt.wait()

            alert("You are now the owner of this product!!!")
        }


        // if (!response.ok)
        //     throw new Error(response.statusText);

        // const json = await response.json();
        // console.log(json.image)


        document.querySelector('#submit-token').addEventListener('click', async function (event) {
            event.preventDefault()
            await getProduct();
        });

        document.querySelector("#show_product").addEventListener('click', async function (event) {
            event.preventDefault();
            await buyProduct();
        });

    </script>

</body>

</html>